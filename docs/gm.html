<!DOCTYPE html>
<html lang="en">
<head>
    <!-- File Path: /docs/gm.html -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM COMMAND CENTER // INTELLIGENCE NETWORK</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
        
        :root {
            --primary-bg: #0a0b0d;
            --secondary-bg: #1a1d23;
            --tertiary-bg: #252830;
            --accent-red: #ff3366;
            --accent-amber: #ffa500;
            --accent-blue: #00d4ff;
            --accent-green: #00ff88;
            --text-primary: #ffffff;
            --text-secondary: #b8bcc8;
            --text-muted: #6c7293;
            --border-color: #3d4147;
            --glow-red: 0 0 20px rgba(255, 51, 102, 0.3);
            --glow-blue: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 51, 102, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 212, 255, 0.03) 0%, transparent 50%);
        }
        
        .header {
            background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
            border-bottom: 2px solid var(--accent-red);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-red);
            text-shadow: var(--glow-red);
            letter-spacing: 2px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .auth-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-status.authenticated {
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .auth-status.unauthenticated {
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        .auth-status:hover {
            box-shadow: 0 0 15px rgba(255, 51, 102, 0.3);
        }
        
        .tab-nav {
            display: flex;
            gap: 0.5rem;
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover, .tab-btn.active {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            box-shadow: var(--glow-blue);
        }
        
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .deployment-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        
        .panel {
            background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-red), transparent);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-red);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-red), #cc1144);
            color: white;
            border: 1px solid var(--accent-red);
        }
        
        .btn-primary:hover:not(:disabled) {
            box-shadow: var(--glow-red);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 165, 0, 0.1);
            color: var(--accent-amber);
            border: 1px solid var(--accent-amber);
        }
        
        .btn-success {
            background: rgba(0, 255, 136, 0.1);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .btn-blue {
            background: linear-gradient(135deg, var(--accent-blue), #0099cc);
            color: white;
            border: 1px solid var(--accent-blue);
        }
        
        .btn-blue:hover:not(:disabled) {
            box-shadow: var(--glow-blue);
            transform: translateY(-2px);
        }
        
        .quick-action-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-action-card:hover {
            border-color: var(--accent-red);
            box-shadow: 0 4px 20px rgba(255, 51, 102, 0.2);
        }
        
        .quick-action-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quick-action-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .quick-action-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .active-mission {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid var(--accent-amber);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .mission-name {
            font-weight: 700;
            color: var(--accent-amber);
            margin-bottom: 0.5rem;
        }
        
        .mission-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .timer-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-family: 'Orbitron', monospace;
            color: var(--accent-amber);
            text-align: center;
        }
        
        .asset-management-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .asset-item:hover {
            border-color: var(--accent-red);
        }
        
        .asset-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .asset-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-available { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .status-deployed { background: rgba(255, 165, 0, 0.2); color: var(--accent-amber); }
        .status-injured { background: rgba(255, 51, 102, 0.2); color: var(--accent-red); }
        
        .deployment-workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            min-height: 400px;
        }
        
        .mission-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mission-card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
        }
        
        .mission-card.selected {
            border-color: var(--accent-blue);
            background: rgba(0, 212, 255, 0.1);
            box-shadow: var(--glow-blue);
        }
        
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .asset-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .asset-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.2);
        }
        
        .asset-card.selected {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }
        
        .stats-mini {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .stat-mini {
            text-align: center;
            padding: 0.25rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
            border: 2px solid var(--accent-red);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .modal-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-red);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: var(--accent-red);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-red);
            box-shadow: 0 0 10px rgba(255, 51, 102, 0.2);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .stats-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--accent-green);
        }
        
        .notification.error {
            background: var(--accent-red);
        }
        
        .notification.warning {
            background: var(--accent-amber);
        }
        
        .auth-warning {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .deployment-grid {
                grid-template-columns: 1fr;
            }
            
            .deployment-workspace {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-cog"></i> GM COMMAND CENTER
            </div>
            <div class="header-controls">
                <div class="auth-status" id="authStatus" onclick="handleAuthClick()">
                    <i class="fas fa-lock"></i>
                    <span>Checking Auth...</span>
                </div>
                <div class="tab-nav">
                    <div class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</div>
                    <div class="tab-btn" onclick="switchTab('deployment')">Mission Deploy</div>
                    <a href="index.html" class="tab-btn" style="text-decoration: none;">Player View</a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="main-container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div id="authWarning" class="auth-warning" style="display: none;">
                <h3 style="color: var(--accent-red); margin-bottom: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> Authentication Required
                </h3>
                <p style="margin-bottom: 1rem;">To create assets, missions, and modify game data, you need to authenticate with GitHub.</p>
                <button class="btn btn-primary" onclick="showTokenModal()">
                    <i class="fas fa-key"></i> Add GitHub Token
                </button>
            </div>
            
            <div class="dashboard-grid">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-bolt"></i> Quick Actions</h2>
                        <button class="btn btn-secondary" onclick="refreshAllData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="quick-action-card" onclick="checkAuthAndRun(() => openModal('assetModal'))">
                        <div class="quick-action-title">Create New Asset</div>
                        <div class="quick-action-desc">Recruit a new intelligence operative</div>
                    </div>
                    
                    <div class="quick-action-card" onclick="checkAuthAndRun(() => openModal('missionModal'))">
                        <div class="quick-action-title">Create New Mission</div>
                        <div class="quick-action-desc">Plan a new intelligence operation</div>
                    </div>
                    
                    <div class="quick-action-card" onclick="checkAuthAndRun(processPayroll)">
                        <div class="quick-action-title">Process Monthly Payroll</div>
                        <div class="quick-action-desc">Deduct monthly costs from treasury</div>
                    </div>
                    
                    <div class="quick-action-card" onclick="checkAuthAndRun(() => openModal('treasuryModal'))">
                        <div class="quick-action-title">Adjust Treasury</div>
                        <div class="quick-action-desc">Add/remove funds from network budget</div>
                    </div>
                    
                    <div class="quick-action-card" onclick="generateRandomEvent()">
                        <div class="quick-action-title">Generate Random Event</div>
                        <div class="quick-action-desc">Create story complications or opportunities</div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-clock"></i> Active Operations</h2>
                    </div>
                    
                    <div class="active-missions-container">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-satellite-dish fa-spin fa-2x"></i>
                            <p style="margin-top: 1rem;">Loading active operations...</p>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-users-cog"></i> Asset Roster</h2>
                    </div>
                    
                    <div class="asset-management-list">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-satellite-dish fa-spin fa-2x"></i>
                            <p style="margin-top: 1rem;">Loading asset roster...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mission Deployment Tab -->
        <div id="deployment" class="tab-content">
            <div class="deployment-grid">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-chess"></i> Mission Deployment Center</h2>
                        <button class="btn btn-blue" onclick="loadPlannedMissions()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="deployment-workspace">
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--accent-blue);">
                                <i class="fas fa-crosshairs"></i> Select Mission
                            </h3>
                            <div id="missionsContainer">
                                <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                    <i class="fas fa-satellite-dish fa-spin fa-2x"></i>
                                    <p style="margin-top: 1rem;">Loading planned missions...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 1rem; color: var(--accent-green);">
                                <i class="fas fa-users"></i> Available Assets
                            </h3>
                            <div class="asset-grid" id="assetsContainer">
                                <div style="text-align: center; color: var(--text-muted); padding: 2rem; grid-column: 1 / -1;">
                                    <i class="fas fa-satellite-dish fa-spin fa-2x"></i>
                                    <p style="margin-top: 1rem;">Loading available assets...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><i class="fas fa-calculator"></i> Deployment Analysis</h3>
                    </div>
                    
                    <div id="selectedMissionInfo">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-crosshairs"></i>
                            <p style="margin-top: 0.5rem;">Select a mission to analyze</p>
                        </div>
                    </div>
                    
                    <div id="selectedAssetsInfo">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-users"></i>
                            <p style="margin-top: 0.5rem;">Select assets for deployment</p>
                        </div>
                    </div>
                    
                    <div id="deploymentControls" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Deployment Start</label>
                            <input type="datetime-local" id="deploymentStart" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration (Hours)</label>
                            <input type="number" id="missionDuration" class="form-input" value="72" min="1" max="720">
                        </div>
                        
                        <button class="btn btn-success" style="width: 100%; margin-top: 1rem;" onclick="deployMission()">
                            <i class="fas fa-rocket"></i> Deploy Mission
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Asset Creation Modal -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Asset</h3>
                <button class="close-btn" onclick="closeModal('assetModal')">&times;</button>
            </div>
            
            <form id="assetForm" onsubmit="createNewAsset(event)">
                <div class="form-group">
                    <label class="form-label">Asset Name</label>
                    <input type="text" name="real_name" class="form-input" placeholder="Marcus Blackthorne" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Codename</label>
                    <input type="text" name="codename" class="form-input" placeholder="Blackthorne">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select name="realm" class="form-select" required>
                        <option value="Mortal Coil">Mortal Coil</option>
                        <option value="Winter Court">Winter Court - Never Never</option>
                        <option value="Summer Court">Summer Court - Never Never</option>
                        <option value="Hell">Hell</option>
                        <option value="Abyss">Abyss</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Region</label>
                    <input type="text" name="region" class="form-input" placeholder="Chicago, Illinois">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stats (1-10)</label>
                    <div class="stats-input-grid">
                        <div>
                            <label class="form-label" style="margin-bottom: 0.25rem;">Skill</label>
                            <input type="number" name="skill" class="form-input" min="1" max="10" value="5" required>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.25rem;">Stealth</label>
                            <input type="number" name="stealth" class="form-input" min="1" max="10" value="5" required>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.25rem;">Combat</label>
                            <input type="number" name="combat" class="form-input" min="1" max="10" value="5" required>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.25rem;">Tech</label>
                            <input type="number" name="tech" class="form-input" min="1" max="10" value="5" required>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.25rem;">Social</label>
                            <input type="number" name="social" class="form-input" min="1" max="10" value="5" required>
                        </div>
                        <div>
                            <label class="form-label" style="margin-bottom: 0.25rem;">Will</label>
                            <input type="number" name="will" class="form-input" min="1" max="10" value="5" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Monthly Salary ($)</label>
                    <input type="number" name="monthly_salary" class="form-input" placeholder="2500" value="2500">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-textarea" placeholder="Background, abilities, and quirks..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> Create Asset
                </button>
            </form>
        </div>
    </div>
    
    <!-- Mission Creation Modal -->
    <div class="modal" id="missionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Mission</h3>
                <button class="close-btn" onclick="closeModal('missionModal')">&times;</button>
            </div>
            
            <form id="missionForm" onsubmit="createNewMission(event)">
                <div class="form-group">
                    <label class="form-label">Mission Codename</label>
                    <input type="text" name="codename" class="form-input" placeholder="OPERATION NIGHTFALL" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Classification</label>
                    <select name="classification" class="form-select" required>
                        <option value="CLASSIFIED">CLASSIFIED</option>
                        <option value="SECRET">SECRET</option>
                        <option value="TOP SECRET">TOP SECRET</option>
                        <option value="EYES ONLY">EYES ONLY</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Primary Objective</label>
                    <textarea name="primary_objective" class="form-textarea" placeholder="Infiltrate target location and gather intelligence..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Target Realm</label>
                    <select name="target_realm" class="form-select" required>
                        <option value="Mortal Coil">Mortal Coil</option>
                        <option value="Winter Court">Winter Court</option>
                        <option value="Summer Court">Summer Court</option>
                        <option value="Hell">Hell</option>
                        <option value="Abyss">Abyss</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Risk Level</label>
                    <select name="risk_level" class="form-select" required>
                        <option value="LOW">LOW</option>
                        <option value="MEDIUM" selected>MEDIUM</option>
                        <option value="HIGH">HIGH</option>
                        <option value="EXTREME">EXTREME</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Duration (Hours)</label>
                    <input type="number" name="duration_hours" class="form-input" placeholder="72" value="72" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mission Status</label>
                    <select name="mission_status" class="form-select" required>
                        <option value="PLANNING">PLANNING (Hidden from players)</option>
                        <option value="ACTIVE">ACTIVE (Visible to players)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> Create Mission
                </button>
            </form>
        </div>
    </div>
    
    <!-- Treasury Modal -->
    <div class="modal" id="treasuryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adjust Treasury</h3>
                <button class="close-btn" onclick="closeModal('treasuryModal')">&times;</button>
            </div>
            
            <form id="treasuryForm" onsubmit="adjustTreasury(event)">
                <div class="form-group">
                    <label class="form-label">Amount ($)</label>
                    <input type="number" name="amount" class="form-input" placeholder="50000" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Transaction Type</label>
                    <select name="transaction_type" class="form-select" required>
                        <option value="add">Add Funds</option>
                        <option value="subtract">Subtract Funds</option>
                        <option value="set">Set Treasury To</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <input type="text" name="reason" class="form-input" placeholder="Funding from benefactor..." required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-dollar-sign"></i> Update Treasury
                </button>
            </form>
        </div>
    </div>
    
    <!-- Load dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="js/data-loader.js"></script>
    
    <script>
        // Global variables
        let selectedMission = null;
        let selectedAssets = new Set();
        let availableAssets = [];
        let plannedMissions = [];
        
        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            initializeGMInterface();
        });
        
        async function initializeGMInterface() {
            try {
                updateAuthStatus();
                await loadGMData();
                
                // Set default deployment time
                const now = new Date();
                const deploymentStart = document.getElementById('deploymentStart');
                if (deploymentStart) {
                    deploymentStart.value = now.toISOString().slice(0, 16);
                }
                
            } catch (error) {
                console.error('Failed to initialize GM interface:', error);
                showNotification('Failed to load data', 'error');
            }
        }
        
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            const authWarning = document.getElementById('authWarning');
            
            if (intelligenceAPI && intelligenceAPI.canWrite()) {
                authStatus.className = 'auth-status authenticated';
                authStatus.innerHTML = '<i class="fas fa-unlock"></i><span>Authenticated</span>';
                authWarning.style.display = 'none';
            } else {
                authStatus.className = 'auth-status unauthenticated';
                authStatus.innerHTML = '<i class="fas fa-lock"></i><span>Read-Only Mode</span>';
                authWarning.style.display = 'block';
            }
        }
        
        function handleAuthClick() {
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showTokenModal();
            }
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'deployment') {
                loadPlannedMissions();
                loadAvailableAssets();
            }
        }
        
        async function loadGMData() {
            try {
                showLoadingState();
                
                const [assets, operations, gameState] = await Promise.all([
                    intelligenceAPI.loadAssets(),
                    intelligenceAPI.loadOperations(),
                    intelligenceAPI.loadGameState()
                ]);
                
                await populateActiveMissions(operations);
                await populateAssetManagement(assets);
                
                hideLoadingState();
                console.log('GM Interface loaded successfully');
                
            } catch (error) {
                console.error('Failed to load GM interface:', error);
                showErrorState(error);
            }
        }
        
        async function populateActiveMissions(operations) {
            const container = document.querySelector('.active-missions-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            const activeOps = operations.filter(op => op.deployment?.status === 'ACTIVE');
            
            if (activeOps.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <i class="fas fa-inbox fa-2x"></i>
                        <p style="margin-top: 1rem;">No active operations</p>
                        <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="checkAuthAndRun(() => openModal('missionModal'))">
                            Create First Mission
                        </button>
                    </div>
                `;
                return;
            }
            
            activeOps.forEach(operation => {
                const timeRemaining = intelligenceAPI.calculateTimeRemaining(operation);
                const assignedAssets = operation.deployment?.assigned_assets || [];
                
                const missionCard = document.createElement('div');
                missionCard.className = 'active-mission';
                missionCard.innerHTML = `
                    <div class="mission-name">${operation.codename}</div>
                    <div class="mission-details">
                        Assets: ${assignedAssets.length} deployed<br>
                        Target: ${operation.objective?.primary || 'Classified'}
                    </div>
                    ${timeRemaining ? `
                        <div class="timer-display">
                            <i class="fas fa-hourglass-half"></i> ${timeRemaining.display}
                        </div>
                    ` : ''}
                    <button class="btn btn-primary" style="margin-top: 0.5rem; width: 100%;" 
                            onclick="resolveMissionPrompt('${operation.operation_id}')">
                        RESOLVE MISSION
                    </button>
                `;
                
                container.appendChild(missionCard);
            });
        }
        
        async function populateAssetManagement(assets) {
            const container = document.querySelector('.asset-management-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (assets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <i class="fas fa-users fa-2x"></i>
                        <p style="margin-top: 1rem;">No assets recruited</p>
                        <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="checkAuthAndRun(() => openModal('assetModal'))">
                            Create First Asset
                        </button>
                    </div>
                `;
                return;
            }
            
            assets.forEach(asset => {
                const statusClass = `status-${asset.status?.current || 'available'}`;
                const statusText = asset.status?.current?.charAt(0).toUpperCase() + 
                                 asset.status?.current?.slice(1) || 'Available';
                
                const assetItem = document.createElement('div');
                assetItem.className = 'asset-item';
                assetItem.innerHTML = `
                    <div>
                        <div class="asset-name">${asset.real_name || asset.codename}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            ${asset.location?.realm} - ${asset.location?.region || 'Unknown'}
                        </div>
                    </div>
                    <div class="asset-status ${statusClass}">${statusText}</div>
                `;
                
                assetItem.addEventListener('click', () => openAssetEditor(asset));
                container.appendChild(assetItem);
            });
        }
        
        async function loadPlannedMissions() {
            try {
                const operations = await intelligenceAPI.loadOperations();
                plannedMissions = operations.filter(op => 
                    op.deployment?.status === 'PLANNING'
                );
                
                const container = document.getElementById('missionsContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (plannedMissions.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-inbox fa-2x"></i>
                            <p style="margin-top: 1rem;">No planned missions</p>
                            <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="checkAuthAndRun(() => openModal('missionModal'))">
                                Create Mission
                            </button>
                        </div>
                    `;
                    return;
                }
                
                plannedMissions.forEach(mission => {
                    const card = document.createElement('div');
                    card.className = 'mission-card';
                    card.onclick = () => selectMission(mission);
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="font-weight: 700; color: var(--accent-blue);">${mission.codename}</div>
                            <div style="font-size: 0.8rem; padding: 0.2rem 0.5rem; background: rgba(255, 51, 102, 0.2); color: var(--accent-red); border-radius: 4px;">
                                ${mission.classification}
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            ${mission.objective?.primary || 'Classified objective'}
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted);">
                            <span><i class="fas fa-map-marker-alt"></i> ${mission.target?.location?.realm || 'Unknown'}</span>
                            <span><i class="fas fa-exclamation-triangle"></i> ${mission.risks?.level || 'MEDIUM'}</span>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
            } catch (error) {
                console.error('Failed to load planned missions:', error);
                showNotification('Failed to load missions', 'error');
            }
        }
        
        async function loadAvailableAssets() {
            try {
                const assets = await intelligenceAPI.loadAssets();
                availableAssets = assets.filter(asset => 
                    asset.status?.current === 'available'
                );
                
                const container = document.getElementById('assetsContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (availableAssets.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem; grid-column: 1 / -1;">
                            <i class="fas fa-users fa-2x"></i>
                            <p style="margin-top: 1rem;">No available assets</p>
                        </div>
                    `;
                    return;
                }
                
                availableAssets.forEach(asset => {
                    const card = document.createElement('div');
                    card.className = 'asset-card';
                    card.onclick = () => toggleAssetSelection(asset);
                    
                    const realmInfo = intelligenceAPI.getRealmInfo(asset.location?.realm || 'Mortal Coil');
                    
                    card.innerHTML = `
                        <div class="asset-name" style="font-size: 0.9rem;">${asset.real_name || asset.codename}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                            <i class="${realmInfo.icon}" style="color: ${realmInfo.color};"></i>
                            ${asset.location?.realm || 'Unknown'}
                        </div>
                        <div class="stats-mini">
                            <div class="stat-mini">SK: ${asset.stats?.skill || 0}</div>
                            <div class="stat-mini">ST: ${asset.stats?.stealth || 0}</div>
                            <div class="stat-mini">CB: ${asset.stats?.combat || 0}</div>
                            <div class="stat-mini">TC: ${asset.stats?.tech || 0}</div>
                            <div class="stat-mini">SO: ${asset.stats?.social || 0}</div>
                            <div class="stat-mini">WL: ${asset.stats?.will || 0}</div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
            } catch (error) {
                console.error('Failed to load available assets:', error);
                showNotification('Failed to load assets', 'error');
            }
        }
        
        function selectMission(mission) {
            document.querySelectorAll('.mission-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.mission-card').classList.add('selected');
            selectedMission = mission;
            
            updateMissionInfo();
            updateDeploymentAnalysis();
        }
        
        function toggleAssetSelection(asset) {
            const card = event.target.closest('.asset-card');
            
            if (selectedAssets.has(asset.asset_id)) {
                selectedAssets.delete(asset.asset_id);
                card.classList.remove('selected');
            } else {
                selectedAssets.add(asset.asset_id);
                card.classList.add('selected');
            }
            
            updateSelectedAssetsInfo();
            updateDeploymentAnalysis();
        }
        
        function updateMissionInfo() {
            if (!selectedMission) return;
            
            const container = document.getElementById('selectedMissionInfo');
            if (!container) return;
            
            container.innerHTML = `
                <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="color: var(--accent-blue); margin-bottom: 0.5rem;">
                        <i class="fas fa-crosshairs"></i> ${selectedMission.codename}
                    </h4>
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                        ${selectedMission.objective?.primary || 'Classified'}
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                        <div><strong>Target:</strong> ${selectedMission.target?.location?.realm || 'Unknown'}</div>
                        <div><strong>Risk:</strong> ${selectedMission.risks?.level || 'MEDIUM'}</div>
                        <div><strong>Duration:</strong> ${selectedMission.timeline?.estimated_duration_hours || 24}h</div>
                        <div><strong>Min Assets:</strong> ${selectedMission.requirements?.minimum_agents || 1}</div>
                    </div>
                </div>
            `;
        }
        
        function updateSelectedAssetsInfo() {
            const container = document.getElementById('selectedAssetsInfo');
            if (!container) return;
            
            if (selectedAssets.size === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <i class="fas fa-users"></i>
                        <p style="margin-top: 0.5rem;">Select assets for deployment</p>
                    </div>
                `;
                return;
            }
            
            const selectedAssetsList = availableAssets.filter(asset => 
                selectedAssets.has(asset.asset_id)
            );
            
            container.innerHTML = `
                <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h5 style="color: var(--accent-green); margin-bottom: 0.5rem;">
                        <i class="fas fa-check"></i> Selected Assets (${selectedAssets.size})
                    </h5>
                    ${selectedAssetsList.map(asset => 
                        `<span style="display: inline-block; background: var(--accent-green); color: var(--primary-bg); padding: 0.25rem 0.5rem; margin: 0.25rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${asset.real_name || asset.codename}</span>`
                    ).join('')}
                </div>
            `;
        }
        
        function updateDeploymentAnalysis() {
            const controls = document.getElementById('deploymentControls');
            if (!controls) return;
            
            if (selectedMission && selectedAssets.size > 0) {
                controls.style.display = 'block';
                
                const durationInput = document.getElementById('missionDuration');
                if (durationInput) {
                    durationInput.value = selectedMission.timeline?.estimated_duration_hours || 72;
                }
            } else {
                controls.style.display = 'none';
            }
        }
        
        function checkAuthAndRun(func) {
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showNotification('GitHub authentication required for this action', 'warning');
                showTokenModal();
                return;
            }
            func();
        }
        
        async function createNewAsset(event) {
            event.preventDefault();
            
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showNotification('GitHub authentication required', 'error');
                return;
            }
            
            try {
                const formData = new FormData(event.target);
                const assetData = {
                    real_name: formData.get('real_name'),
                    codename: formData.get('codename') || formData.get('real_name'),
                    description: formData.get('description'),
                    location: {
                        realm: formData.get('realm'),
                        region: formData.get('region')
                    },
                    stats: {
                        skill: parseInt(formData.get('skill')),
                        stealth: parseInt(formData.get('stealth')),
                        combat: parseInt(formData.get('combat')),
                        tech: parseInt(formData.get('tech')),
                        social: parseInt(formData.get('social')),
                        will: parseInt(formData.get('will'))
                    },
                    costs: {
                        monthly_salary: parseInt(formData.get('monthly_salary'))
                    }
                };
                
                showNotification('Creating asset...', 'warning');
                const asset = await intelligenceAPI.createAsset(assetData);
                
                showNotification(`Asset "${asset.real_name}" created successfully!`, 'success');
                closeModal('assetModal');
                
                document.getElementById('assetForm').reset();
                await loadGMData();
                
            } catch (error) {
                console.error('Failed to create asset:', error);
                showNotification(`Failed to create asset: ${error.message}`, 'error');
            }
        }
        
        async function createNewMission(event) {
            event.preventDefault();
            
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showNotification('GitHub authentication required', 'error');
                return;
            }
            
            try {
                const formData = new FormData(event.target);
                const missionData = {
                    codename: formData.get('codename'),
                    classification: formData.get('classification'),
                    objective: {
                        primary: formData.get('primary_objective')
                    },
                    target: {
                        location: {
                            realm: formData.get('target_realm')
                        }
                    },
                    risks: {
                        level: formData.get('risk_level')
                    },
                    timeline: {
                        estimated_duration_hours: parseInt(formData.get('duration_hours'))
                    },
                    deployment: {
                        status: formData.get('mission_status')
                    }
                };
                
                showNotification('Creating mission...', 'warning');
                const mission = await intelligenceAPI.createOperation(missionData);
                
                showNotification(`Mission "${mission.codename}" created successfully!`, 'success');
                closeModal('missionModal');
                
                document.getElementById('missionForm').reset();
                await loadGMData();
                
            } catch (error) {
                console.error('Failed to create mission:', error);
                showNotification(`Failed to create mission: ${error.message}`, 'error');
            }
        }
        
        async function adjustTreasury(event) {
            event.preventDefault();
            
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showNotification('GitHub authentication required', 'error');
                return;
            }
            
            try {
                const formData = new FormData(event.target);
                const amount = parseInt(formData.get('amount'));
                const type = formData.get('transaction_type');
                
                const gameState = await intelligenceAPI.loadGameState();
                const currentFunds = gameState.treasury?.current_funds || 0;
                
                let newFunds;
                switch (type) {
                    case 'add':
                        newFunds = currentFunds + amount;
                        break;
                    case 'subtract':
                        newFunds = currentFunds - amount;
                        break;
                    case 'set':
                        newFunds = amount;
                        break;
                }
                
                await intelligenceAPI.updateGameState({
                    treasury: {
                        ...gameState.treasury,
                        current_funds: newFunds
                    }
                });
                
                showNotification(`Treasury ${type}d: $${amount.toLocaleString()}. New balance: $${newFunds.toLocaleString()}`, 'success');
                closeModal('treasuryModal');
                
                document.getElementById('treasuryForm').reset();
                await loadGMData();
                
            } catch (error) {
                console.error('Failed to adjust treasury:', error);
                showNotification(`Failed to adjust treasury: ${error.message}`, 'error');
            }
        }
        
        async function deployMission() {
            if (!selectedMission || selectedAssets.size === 0) {
                showNotification('Please select mission and assets', 'warning');
                return;
            }
            
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showNotification('GitHub authentication required', 'error');
                return;
            }
            
            try {
                const deploymentStart = document.getElementById('deploymentStart').value;
                const duration = parseInt(document.getElementById('missionDuration').value);
                
                if (!deploymentStart || duration < 1) {
                    showNotification('Please set valid deployment time and duration', 'warning');
                    return;
                }
                
                const startTime = new Date(deploymentStart);
                const completionTime = new Date(startTime.getTime() + (duration * 60 * 60 * 1000));
                
                await intelligenceAPI.updateOperation(selectedMission.operation_id, {
                    deployment: {
                        ...selectedMission.deployment,
                        status: 'ACTIVE',
                        assigned_assets: Array.from(selectedAssets),
                        deployment_date: startTime.toISOString(),
                        expected_completion: completionTime.toISOString()
                    }
                });
                
                const selectedAssetsList = availableAssets.filter(asset => 
                    selectedAssets.has(asset.asset_id)
                );
                
                for (const asset of selectedAssetsList) {
                    await intelligenceAPI.updateAsset(asset.asset_id, {
                        status: {
                            current: 'deployed',
                            since_date: startTime.toISOString().split('T')[0],
                            deployment_details: selectedMission.operation_id
                        }
                    });
                }
                
                showNotification(`Mission "${selectedMission.codename}" deployed with ${selectedAssets.size} assets!`, 'success');
                
                selectedMission = null;
                selectedAssets.clear();
                document.querySelectorAll('.mission-card, .asset-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                await loadGMData();
                await loadPlannedMissions();
                await loadAvailableAssets();
                
            } catch (error) {
                console.error('Failed to deploy mission:', error);
                showNotification(`Failed to deploy mission: ${error.message}`, 'error');
            }
        }
        
        async function processPayroll() {
            try {
                const assets = await intelligenceAPI.loadAssets();
                const gameState = await intelligenceAPI.loadGameState();
                
                const totalCosts = assets.reduce((sum, asset) => 
                    sum + (asset.costs?.monthly_salary || 0), 0
                );
                
                const currentFunds = gameState.treasury?.current_funds || 0;
                const newFunds = currentFunds - totalCosts;
                
                await intelligenceAPI.updateGameState({
                    treasury: {
                        ...gameState.treasury,
                        current_funds: newFunds,
                        last_payroll_date: new Date().toISOString().split('T')[0]
                    }
                });
                
                showNotification(`Payroll processed! Total costs: $${totalCosts.toLocaleString()}. Remaining: $${newFunds.toLocaleString()}`, 'success');
                await loadGMData();
                
            } catch (error) {
                console.error('Payroll processing failed:', error);
                showNotification(`Failed to process payroll: ${error.message}`, 'error');
            }
        }
        
        function resolveMissionPrompt(missionId) {
            const outcomes = ['failure', 'partial1', 'partial2', 'partial3', 'partial4', 'success'];
            const outcomeLabels = ['Total Failure', 'Partial Success 1', 'Partial Success 2', 'Partial Success 3', 'Partial Success 4', 'Complete Success'];
            
            let options = 'Select mission outcome:\n\n';
            outcomeLabels.forEach((label, index) => {
                options += `${index + 1}. ${label}\n`;
            });
            
            const selected = prompt(options + '\nEnter number (1-6):');
            const selectedIndex = parseInt(selected) - 1;
            
            if (selectedIndex >= 0 && selectedIndex < outcomes.length) {
                resolveMissionWithOutcome(missionId, outcomes[selectedIndex]);
            }
        }
        
        async function resolveMissionWithOutcome(missionId, outcome) {
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                showNotification('GitHub authentication required', 'error');
                return;
            }
            
            try {
                const operation = await intelligenceAPI.getOperation(missionId);
                if (!operation) {
                    showNotification('Mission not found!', 'error');
                    return;
                }
                
                await intelligenceAPI.updateOperation(missionId, {
                    deployment: {
                        ...operation.deployment,
                        status: 'COMPLETED'
                    },
                    results: {
                        completion_date: new Date().toISOString(),
                        success_level: outcome,
                        handler_notes: `Resolved with ${outcome}`
                    }
                });
                
                const assignedAssets = operation.deployment?.assigned_assets || [];
                for (const assetId of assignedAssets) {
                    await intelligenceAPI.updateAsset(assetId, {
                        status: {
                            current: 'available',
                            since_date: new Date().toISOString().split('T')[0]
                        }
                    });
                }
                
                showNotification(`Mission "${operation.codename}" resolved with ${outcome}!`, 'success');
                await loadGMData();
                
            } catch (error) {
                console.error('Mission resolution failed:', error);
                showNotification(`Failed to resolve mission: ${error.message}`, 'error');
            }
        }
        
        function generateRandomEvent() {
            const events = [
                'A rival intelligence network has been detected in your territory',
                'One of your assets has discovered a major supernatural threat',
                'Political tensions in the Never Never have escalated',
                'A wealthy patron offers funding in exchange for a favor',
                'Law enforcement is investigating supernatural activities',
                'An asset has gone dark - last known location unknown',
                'Intel suggests a major supernatural summit is being planned',
                'Strange energy readings detected in multiple realms',
                'A new faction has emerged in the supernatural underground',
                'One of your contacts has been compromised',
                'A powerful artifact has surfaced in the black market',
                'Territorial dispute erupting between supernatural factions'
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Random Event Generated</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: var(--accent-amber); font-weight: 600; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i> SITUATION DEVELOPMENT
                        </p>
                        <p style="color: var(--text-primary); line-height: 1.5;">
                            ${randomEvent}
                        </p>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
                        Consider how this affects ongoing operations, asset safety, and future mission planning.
                    </div>
                    <button onclick="this.closest('.modal').remove()" class="btn btn-primary" style="width: 100%;">
                        ACKNOWLEDGED
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function refreshAllData() {
            try {
                showNotification('Refreshing all data...', 'warning');
                await intelligenceAPI.refreshAllData();
                await loadGMData();
                await loadPlannedMissions();
                await loadAvailableAssets();
                showNotification('All data refreshed successfully!', 'success');
            } catch (error) {
                console.error('Failed to refresh data:', error);
                showNotification(`Failed to refresh data: ${error.message}`, 'error');
            }
        }
        
        function openAssetEditor(asset) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Asset Details: ${asset.real_name || asset.codename}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>Codename:</strong> ${asset.codename}</p>
                        <p><strong>Location:</strong> ${asset.location?.realm} - ${asset.location?.region}</p>
                        <p><strong>Status:</strong> ${asset.status?.current || 'available'}</p>
                        <p><strong>Monthly Cost:</strong> $${(asset.costs?.monthly_salary || 0).toLocaleString()}</p>
                        
                        <div style="margin-top: 1rem;">
                            <strong>Stats:</strong><br>
                            Skill: ${asset.stats?.skill || 0} | 
                            Stealth: ${asset.stats?.stealth || 0} | 
                            Combat: ${asset.stats?.combat || 0}<br>
                            Tech: ${asset.stats?.tech || 0} | 
                            Social: ${asset.stats?.social || 0} | 
                            Will: ${asset.stats?.will || 0}
                        </div>
                        
                        ${asset.description ? `<div style="margin-top: 1rem;"><strong>Description:</strong><br>${asset.description}</div>` : ''}
                    </div>
                    <button onclick="this.closest('.modal').remove()" class="btn btn-primary" style="width: 100%;">
                        CLOSE
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function openModal(modalId) {
            if (!intelligenceAPI || !intelligenceAPI.canWrite()) {
                if (modalId === 'assetModal' || modalId === 'missionModal') {
                    showNotification('GitHub authentication required', 'warning');
                    showTokenModal();
                    return;
                }
            }
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function showTokenModal() {
            if (typeof intelligenceUI !== 'undefined' && intelligenceUI.showTokenModal) {
                intelligenceUI.showTokenModal();
            } else {
                // Fallback token modal
                const token = prompt('Enter your GitHub Personal Access Token:\n\n(Create one at GitHub Settings > Developer settings > Personal access tokens)\nNeeds "repo" scope for write access.');
                if (token) {
                    intelligenceAPI.setGitHubToken(token);
                    updateAuthStatus();
                    showNotification('GitHub token saved successfully!', 'success');
                }
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation-triangle'}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function showLoadingState() {
            // Show loading indicators for containers that are loading
        }
        
        function hideLoadingState() {
            // Hide loading indicators
        }
        
        function showErrorState(error) {
            console.error('Error state:', error);
            showNotification('Failed to load data. Check console for details.', 'error');
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
